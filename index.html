<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exam Schedule Finder & Calendar Adder</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Use a default font family from Tailwind */
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

  <div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-md">
    <h3 class="text-2xl font-bold text-gray-900 mb-2">Exam Schedule Finder</h3>
    <div class="text-gray-600 text-sm mb-6">
      Upload the Excel schedule file and enter a student’s name (last, first or first last). It will find all subjects, dates, venues, and desks.
    </div>

    <!-- File Upload -->
    <label for="file" class="block text-sm font-medium text-gray-700 mb-2">Excel file (.xlsx)</label>
    <input id="file" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
           class="block w-full max-w-lg text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">

    <!-- Name Search -->
    <label for="query" class="block text-sm font-medium text-gray-700 mt-4 mb-2">Search name</label>
    <input id="query" type="text" placeholder="e.g. Wessels, Joshua or Joshua Wessels"
           class="block w-full max-w-lg border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2.5">

    <!-- Run Button -->
    <button id="run"
            class="mt-6 px-5 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
      Find Matches
    </button>
    
    <!-- Status Message -->
    <div id="status" class="text-gray-600 text-sm mt-4"></div>

    <!-- Results Area -->
    <div id="results" class="mt-6"></div>
  </div>

  <!-- XLSX Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script>
  document.getElementById('run').onclick = async () => {
    const fileEl = document.getElementById('file');
    const q = (document.getElementById('query').value || '').trim();
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    
    statusEl.textContent = '';
    resultsEl.innerHTML = '';

    if (!fileEl.files || !fileEl.files[0]) {
      statusEl.textContent = 'Please select an Excel file first.';
      return;
    }
    if (!q) {
      statusEl.textContent = 'Please enter a name to search.';
      return;
    }

    const allowed = fileEl.files[0].name.toLowerCase().endsWith('.xlsx');
    if (!allowed) {
      statusEl.textContent = 'That does not look like an Excel .xlsx file.';
      return;
    }

    statusEl.textContent = 'Reading Excel file...';

    try {
      const arrayBuffer = await fileEl.files[0].arrayBuffer();
      const wb = XLSX.read(arrayBuffer, { type: 'array' });

      statusEl.textContent = 'Parsing all sheets...';

      // --- Name Candidate Generation ---
      const qNorm = q.toLowerCase().replace(/[,\.]/g, '').replace(/\s+/g, ' ').trim();
      const parts = qNorm.split(' ');
      let candidates = [];
      if (parts.length >= 2) {
        const first = parts[0];
        const last = parts.slice(1).join(' ');
        candidates.push((last + ' ' + first).toLowerCase());
        candidates.push((first + ' ' + last).toLowerCase());
        candidates.push((last + ', ' + first).toLowerCase());
        candidates.push((last + ',' + first).toLowerCase());
      } else {
        candidates.push(qNorm);
      }
      candidates = Array.from(new Set(candidates));
      // --- End Name Candidate Generation ---

      const results = [];
      for (const sheetName of wb.SheetNames) {
        const sheet = wb.Sheets[sheetName];
        // Use blankrows: false and defval: '' to get raw data
        const data = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false, defval: '' });
        
        if (data.length < 2) continue; // Skip empty sheets

        const header = data[0].map(h => h.toString().trim());

        // --- Header Parsing ---
        // Subject is usually in the first cell
        let subject = header[0].replace(/GR\s*10/i, '').trim() || sheetName;

        const venueCols = [];
        header.forEach((h, i) => { if (h.match(/venue/i)) venueCols.push(i); });

        const deskCols = [];
        header.forEach((h, i) => { if (h.match(/desk/i)) deskCols.push(i); });

        const dateCols = [];
        header.forEach((h, i) => {
          const hStr = h.toString().trim();
          // Regex to find dates like "14 Nov" or "P1 31 Oct"
          if (hStr.match(/\d{1,2}[- \/](?:Oct|Nov|Dec|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep)/i)) {
            let paper = hStr.match(/P(\d)/) ? 'P' + RegExp.$1 : '';
            let dateStr = hStr.replace(/P\d/i, '').replace(/-/g, ' ').trim();
            dateCols.push({ col: i, paper, dateStr });
          }
        });
        // --- End Header Parsing ---

        // This array holds the "filled-down" values for venue, desk, etc.
        let currentValues = new Array(header.length).fill('');

        // --- Row Parsing Loop (MODIFIED) ---
        for (let r = 1; r < data.length; r++) {
          const row = data[r].map(cell => cell.toString().trim());

          // *** FIX 1: Skip row if potential name cols (0 and 1) are BOTH empty ***
          if (!row[0] && !row[1]) continue;

          // *** FIX 2: Apply fill-down logic *every* row ***
          // This ensures that group venues/desks carry over to subsequent students
          for (let c = 0; c < row.length; c++) {
            if (row[c] !== '') currentValues[c] = row[c];
          }

          // *** FIX 3: Check for name match in *current row's* col 0 and col 1 ***
          // We check the *actual* row data, not the filled-down data for the name
          const nameCell1 = (row[0] || '').toLowerCase().replace(/[,\.]/g, '').replace(/\s+/g, ' ').trim();
          const nameCell2 = (row[1] || '').toLowerCase().replace(/[,\.]/g, '').replace(/\s+/g, ' ').trim();

          let matched = false;
          for (const c of candidates) {
            // Check if either cell 0 or cell 1 contains the candidate name
            if (nameCell1.includes(c) || nameCell2.includes(c)) {
              matched = true;
              break;
            }
          }

          // If this row isn't a match for the student, skip to the next row
          if (!matched) continue;

          // --- Found Student: Extract Exam Info ---
          for (const dateInfo of dateCols) {
            const dc = dateInfo.col; // The date's column index
            
            // Find the *last* "Venue" column that appears *before* this date column
            const vCol = venueCols.filter(v => v < dc).pop();
            // Find the *last* "Desk" column that appears *before* this date column
            const dCol = deskCols.filter(d => d < dc).pop();

            // Get the venue/desk from the *filled-down* values
            const venue = (vCol !== undefined ? currentValues[vCol] : '') || 'N/A';
            const desk = (dCol !== undefined ? currentValues[dCol] : '') || 'N/A';

            results.push({
              subject,
              paper: dateInfo.paper,
              dateStr: dateInfo.dateStr,
              venue,
              desk,
              sheet: sheetName
            });
          }
        }
      }
      // --- End Row Parsing Loop ---

      statusEl.textContent = `Found ${results.length} match(es) for "${q}".`;

      if (results.length === 0) {
        resultsEl.innerHTML = '<div class="text-gray-600">No matches found.</div>';
        return;
      }

      // --- Build Results Table ---
      const table = document.createElement('table');
      table.className = "min-w-full divide-y divide-gray-200 bg-white rounded-lg shadow-sm mt-4 border border-gray-200";
      const thead = document.createElement('thead');
      thead.className = "bg-gray-50";
      thead.innerHTML = `<tr>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paper</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Venue</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Desk</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sheet</th>
      </tr>`;
      table.appendChild(thead);
      
      const tbody = document.createElement('tbody');
      tbody.className = "bg-white divide-y divide-gray-200";
      for (const r of results) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 font-medium">${r.subject}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${r.paper || '–'}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${r.dateStr}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${r.venue}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${r.desk}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-400">${r.sheet}</td>
        `;
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      
      resultsEl.innerHTML = ''; // Clear "loading" text
      resultsEl.appendChild(table);

      // --- Add Calendar Button ---
      const addBtn = document.createElement('button');
      addBtn.id = 'addCal';
      addBtn.textContent = 'Add All to Calendar';
      addBtn.className = "mt-6 px-5 py-2.5 bg-green-600 text-white text-sm font-medium rounded-lg shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500";
      resultsEl.appendChild(addBtn);

      addBtn.onclick = () => {
        generateICS(results);
      };

    } catch (error) {
      console.error(error);
      statusEl.textContent = 'An error occurred while processing the file.';
    }
  };

  function generateICS(results) {
    const events = [];
    const monthMap = { jan: 0, feb: 1, mar: 2, apr: 3, may: 4, jun: 5, jul: 6, aug: 7, sep: 8, sept: 8, oct: 9, nov: 10, dec: 11 };
    
    // Assume the current year or next year if the month is early
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth();

    for (const r of results) {
      try {
        const parts = r.dateStr.toLowerCase().split(/[\s\/]+/);
        const day = parseInt(parts[0], 10);
        const monStr = parts[1].slice(0, 3);
        const month = monthMap[monStr];
        
        // Handle year rollover (e.g., if it's Nov 2024, "Jan" probably means Jan 2025)
        const year = (month < currentMonth) ? currentYear + 1 : currentYear;

        const dateObj = new Date(year, month, day);
        if (isNaN(dateObj.getTime())) continue; // Skip invalid dates

        const ymd = dateObj.toISOString().slice(0, 10).replace(/-/g, '');
        const nextDay = new Date(dateObj.getTime() + 86400000); // +1 day for all-day event
        const ymdEnd = nextDay.toISOString().slice(0, 10).replace(/-/g, '');

        const paperStr = r.paper ? `${r.paper} ` : '';
        const title = `${r.subject} ${paperStr}Exam`;
        // Escape characters for ICS
        const desc = `Venue: ${r.venue}\\nDesk: ${r.desk}`.replace(/,/g, '\\,');
        const location = r.venue.replace(/,/g, '\\,');
        const uid = `${r.subject.replace(/\s+/g, '')}-${r.paper || 'main'}-${ymd}@exam-schedule.com`;

        events.push([
          'BEGIN:VEVENT',
          `UID:${uid}`,
          `DTSTART;VALUE=DATE:${ymd}`,
          `DTEND;VALUE=DATE:${ymdEnd}`,
          `SUMMARY:${title}`,
          `DESCRIPTION:${desc}`,
          `LOCATION:${location}`,
          'END:VEVENT'
        ].join('\n'));
      
      } catch (e) {
        console.warn("Could not parse event:", r, e);
      }
    }

    const ics = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//YourApp//ExamScheduler//EN',
      ...events,
      'END:VCALENDAR'
    ].join('\n');

    const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    // Create a temporary link to trigger the download
    const a = document.createElement('a');
    a.href = url;
    a.download = 'exam_schedule.ics';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };
  </script>
</body>
</html>

