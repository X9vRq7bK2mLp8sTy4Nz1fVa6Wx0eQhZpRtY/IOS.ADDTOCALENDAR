<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Log Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial,-serif; }
    .table-container { overflow-x: auto; }
    .spinner {
      border: 4px solid rgba(0, 0, 0, .1);
      border-left-color: #09f;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Style for the two-table toggle buttons */
    .tab-button.active {
        background-color: #2563eb;
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

  <div class="max-w-7xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-xl">
    <h3 class="text-3xl font-bold text-gray-900 mb-6 border-b pb-2">Website Logs Dashboard</h3>

    <!-- Tab Buttons -->
    <div class="flex space-x-2 mb-6">
        <button id="tab-searches" class="tab-button active px-4 py-2 text-sm font-medium rounded-lg text-blue-600 bg-blue-100 hover:bg-blue-200 transition-colors">
            Search Queries
        </button>
        <button id="tab-visitors" class="tab-button px-4 py-2 text-sm font-medium rounded-lg text-gray-600 bg-gray-100 hover:bg-gray-200 transition-colors">
            Visitor Logs
        </button>
    </div>

    <!-- Loading Status -->
    <div id="status" class="text-gray-600 text-sm mt-4 flex items-center gap-2 mb-4">
        <div class="spinner"></div> Loading data...
    </div>

    <!-- Table Container -->
    <div class="table-container overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50" id="log-thead">
          <!-- Table headers will be injected here by JavaScript -->
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="log-data">
          <!-- Log rows will be injected here by JavaScript -->
        </tbody>
      </table>
    </div>

  </div>

  <script>
    // --- SUPABASE CONFIGURATION (Using the Anon Key for Simplicity) ---
    // Please verify the Supabase URL and Key are correct if this dashboard loads forever.
    // The key MUST have SELECT permissions on search_logs and visitor_logs.
    const SUPABASE_URL = 'https://iwngyeebizqaazyulcpt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3bmd5ZWViaXpxYWF6eXVsY3B0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NTExOTIsImV4cCI6MjA3NjEyNzE5Mn0.tO8ky9PKHn90-gPkFeNFOkE9xmT6ki_hayRVzhkpWGg';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const logDataEl = document.getElementById('log-data');
    const logTheadEl = document.getElementById('log-thead');
    const statusEl = document.getElementById('status');
    const tabSearches = document.getElementById('tab-searches');
    const tabVisitors = document.getElementById('tab-visitors');

    let currentView = 'search_logs'; // Default view

    // --- UTILITY FUNCTIONS ---

    // Formats the timestamp to a human-readable SAST-like string
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'N/A';
        // The timestamp is UTC from Supabase, so we use toLocaleString to format
        const date = new Date(timestamp);
        // Using Africa/Johannesburg (SAST)
        return date.toLocaleString('en-ZA', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            timeZoneName: 'short',
            timeZone: 'Africa/Johannesburg' 
        });
    }

    // --- CORE FETCHING & RENDERING ---

    async function fetchData(tableName) {
        statusEl.innerHTML = '<div class="spinner"></div> Fetching data...';

        const { data, error } = await supabase
            .from(tableName)
            .select('*')
            .order('created_at', { ascending: false }) // Show newest logs first
            .limit(100); // Limit to the last 100 entries

        if (error) {
            statusEl.textContent = `Error loading logs from ${tableName}. Check network connection and Supabase policies/key.`;
            logDataEl.innerHTML = '';
            // Critical: Log the detailed error to the console for debugging
            console.error(`Supabase Fetch Error for ${tableName}:`, error);
            return [];
        }

        statusEl.textContent = `Successfully loaded ${data.length} logs from ${tableName}.`;
        return data;
    }

    function renderTable(tableName, data) {
        logDataEl.innerHTML = ''; // Clear existing rows

        if (tableName === 'search_logs') {
            logTheadEl.innerHTML = `
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp (SAST)</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OS</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Browser</th>
                <th class="px-4 py-3 text-left text-sm font-bold text-blue-600 uppercase tracking-wider bg-blue-50">Search Query</th>
              </tr>
            `;
            data.forEach(log => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-yellow-50/50";
                tr.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${formatTimestamp(log.created_at)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${log.device || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${log.os || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${log.browser || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-red-700 bg-blue-50 font-semibold">${log.search_query || 'N/A'}</td>
                `;
                logDataEl.appendChild(tr);
            });
        } else if (tableName === 'visitor_logs') {
             logTheadEl.innerHTML = `
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp (SAST)</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OS</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Browser</th>
              </tr>
            `;
            data.forEach(log => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-yellow-50/50";
                tr.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${formatTimestamp(log.created_at)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${log.device || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${log.os || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${log.browser || 'N/A'}</td>
                `;
                logDataEl.appendChild(tr);
            });
        }
    }

    async function loadLogs(view) {
        currentView = view;
        // Update button styles
        tabSearches.classList.remove('active', 'bg-blue-100', 'text-blue-600');
        tabVisitors.classList.remove('active', 'bg-blue-100', 'text-blue-600');
        tabSearches.classList.add('bg-gray-100', 'text-gray-600');
        tabVisitors.classList.add('bg-gray-100', 'text-gray-600');

        if (view === 'search_logs') {
            tabSearches.classList.add('active', 'bg-blue-100', 'text-blue-600');
            tabSearches.classList.remove('bg-gray-100', 'text-gray-600');
        } else {
            tabVisitors.classList.add('active', 'bg-blue-100', 'text-blue-600');
            tabVisitors.classList.remove('bg-gray-100', 'text-gray-600');
        }

        const data = await fetchData(view);
        renderTable(view, data);
    }

    // --- EVENT LISTENERS ---
    tabSearches.onclick = () => loadLogs('search_logs');
    tabVisitors.onclick = () => loadLogs('visitor_logs');

    // Load initial data on page load
    document.addEventListener('DOMContentLoaded', () => loadLogs(currentView));

  </script>
</body>
</html>

